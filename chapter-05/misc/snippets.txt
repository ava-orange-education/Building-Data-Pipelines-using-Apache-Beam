Chapter 05 - Other code/config snippets (bash/xml/uncategorized)

--- Snippet 1
// longWords will contain: "hello", "world", "beam"

--- Snippet 2: The input sales PCollection contains tuples of fruit names and some numbers. After GroupByKey, the grouped PCollection w
('apple', [3, 5])
('banana', [4, 2])
('orange', [7])

--- Snippet 3: We pass a dictionary {'ages': ages, 'cities': cities} to CoGroupByKey(). The output grouped will be a PCollection of (ke
('Alice', {'ages': [25], 'cities': ['NY']})
('Bob', {'ages': [30], 'cities': []})
('Charles', {'ages': [], 'cities': ['LA']})

--- Snippet 4
// Define tuple tags for each collection
final TupleTag<Integer> ageTag = new TupleTag<>();
final TupleTag<String> cityTag = new TupleTag<>();

--- Snippet 5: Java
grouped.apply("ProcessResults", ParDo.of(new DoFn<KV<String, CoGbkResult>, String>() {
    @ProcessElement
    public void processElement(ProcessContext c) {
        String user = c.element().getKey();
        CoGbkResult result = c.element().getValue();
        Iterable<Integer> ageValues = r&#8203;:contentReference[oaicite:3]{index=3}ageTag);
        Iterable<String> cityValues = result.getAll(cityTag);

--- Snippet 6
        Integer age = ageValues.iterator().hasNext() ? ageValues.iterator().next() : null;
        String city = cityValues.iterator().hasNext() ? cityValues.iterator().next() : null;
        // Now we have at most one age and one city since our data had at most one per user.
        String output = user + ": age=" + age + ", city=" + city;
        System.out.println(output);
        c.output(output);
    }
}));
grouped.apply("ProcessResults", ParDo.of(new DoFn<KV<String, CoGbkResult>, String>() {
    @ProcessElement
    public void processElement(ProcessContext c) {
        String user = c.element().getKey();
        CoGbkResult result = c.element().getValue();

--- Snippet 7
        Iterable<Integer> ageValues = result.getAll(ageTag);
        Iterable<String> cityValues = result.getAll(cityTag);

--- Snippet 8
        Integer age = ageValues.iterator().hasNext() ? ageValues.iterator().next() : null;
        String city = cityValues.iterator().hasNext() ? cityValues.iterator().next() : null;
        // Now we have at most one age and one city since our data had at most one per user.
        String output = user + ": age=" + age + ", city=" + city;
        System.out.println(output);
        c.output(output);
    }
}));

--- Snippet 9: If we ran this pipeline, wâ€‹e get output similar to:
Alice: age=25, city=NY
Bob: age=30, city=null
Charles: age=null, city=LA

--- Snippet 10
// ...

--- Snippet 11
PCollectionList<Integer> partitions = numbers.apply(
    Partition.of(2, (PartitionFn<Integer>) (Integer x, int numPartitions) ->
        (x % 2 == 0) ? 0 : 1
    )
);

--- Snippet 12: Python
from apache_beam.coders import Coder, FastPrimitivesCoder
# use FastPrimitivesCoder for a custom type if it can be treated as tuple of primitives
pipeline.get_coder_registry().register_coder(MyClass, MyClassCoder)

--- Snippet 13: Let's implement this:
# 1. Define input data (could be from a file, but here we'll hard-code some lines)
lines = [
    "Apache Beam is great",
    "Beam unifies batch and streaming",
    "Streaming data is processed with Beam"
]

--- Snippet 14: If we run this pipeline, we might see output (the order might vary) like:
('apache', 1)
('beam', 3)
('is', 2)
('great', 1)
('unifies', 1)
('batch', 1)
('and', 1)
('streaming', 2)
('data', 1)
('processed', 1)
('with', 1)

--- Snippet 15
// 5. Output the results
evenSum.apply(MapElements.into(TypeDescriptors.strings())
            .via(sum -> "Sum of evens: " + sum))
       .apply(PrintElements.via(System.out::println));  // Using a hypothetical PrintElements for simplicity

--- Snippet 16
oddSum.apply(MapElements.into(TypeDescriptors.strings())
           .via(sum -> "Sum of odds: " + sum))
      .apply(PrintElements.via(System.out::println));

--- Snippet 17
    // 5. Format and print (good for local DirectRunner demos)
    evenSum
        .apply("FormatEvenSum", MapElements.into(TypeDescriptors.strings())
            .via(sum -> "Sum of evens: " + sum))
        .apply("PrintEvenSum", ParDo.of(new DoFn<String, Void>() {
          @ProcessElement
          public void processElement(@Element String msg) {
            System.out.println(msg);
          }
        }));

--- Snippet 18
    oddSum
        .apply("FormatOddSum", MapElements.into(TypeDescriptors.strings())
            .via(sum -> "Sum of odds: " + sum))
        .apply("PrintOddSum", ParDo.of(new DoFn<String, Void>() {
          @ProcessElement
          public void processElement(@Element String msg) {
            System.out.println(msg);
          }
        }));

--- Snippet 19
    pipeline.run().waitUntilFinish();
 

--- Snippet 20: If we run this pipeline, the expected output would be:
Sum of evens: 30
Sum of odds: 25

--- Snippet 21: Expected output (order not guaranteed, but let's reason it out):
('Alice', 30, 'Blue')
('Bob', 20, 'Green')
('Charlie', 25, None)
('Diana', None, 'Red')

--- Snippet 22: Python: You specify Dataflow options via the PipelineOptions. Typically, you'd pass command-line arguments or construct 
from apache_beam.options.pipeline_options import PipelineOptions

--- Snippet 23: Java: For Java, you use DataflowPipelineOptions (which extends PipelineOptions). The simplest way is via command-line ar
--runner=DataflowRunner
--project=YOUR_GCP_PROJECT_ID
--region=us-central1
--tempLocation=gs://YOUR_BUCKET/temp
--jobName=beamWordcountExample

--- Snippet 24: If you packaged your pipeline into a fat jar, you might run:
java -jar mypipeline-bundled.jar \
  --runner=DataflowRunner \
  --project=YOUR_GCP_PROJECT_ID \
  --region=us-central1 \
  --tempLocation=gs://YOUR_BUCKET/temp \
  --jobName=beamWordcountExample

--- Snippet 25: If using Maven exec as in the examples:
mvn compile exec:java -Dexec.mainClass=com.example.MyPipelineMain \
    -Dexec.args="--runner=DataflowRunner --project=YOUR_GCP_PROJECT_ID --region=us-central1 --tempLocation=gs://YOUR_BUCKET/temp --jobName=beamWordcountExample"

